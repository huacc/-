# P0阶段前端功能修复执行计划 v1.0

> **创建日期**: 2026-02-19
> **适用项目**: `demo/psychanalysis-ai-platform`（React + TypeScript + Tailwind CSS + Vite）
> **覆盖范围**: P0阶段全量功能缺口修复，共 7 个执行阶段、25 项具体任务

---

## 一、执行策略总览

### 1.1 阶段划分与依赖关系

| Phase | 主题 | 核心工作 | 前置条件 |
|-------|------|---------|---------|
| **Phase 1** | 数据持久化基础层 | 建立各模块 localStorage 数据结构规范 | 无 |
| **Phase 2** | 提示词编辑器架构重构 | 将自由文本编辑器改为结构化表单 | Phase 1 |
| **Phase 3** | 提示词模块功能补全 | 列表切换、保存、分类树、版本管理等 | Phase 2 |
| **Phase 4** | 模型管理模块补全 | 调度策略、性能监控、连接测试等 | Phase 1 |
| **Phase 5** | 元本体管理模块补全 | 版本管理、孤立检查、工具栏完善 | Phase 1 |
| **Phase 6** | 知识图谱模块补全 | AI助手、查询工具、布局、过滤、导入导出 | Phase 1、Phase 5 |
| **Phase 7** | 全局数据联动与UI规范 | 跨模块数据共享、统一加载/空态组件 | Phase 2~6 全部完成 |

> **执行原则**：
> - Phase 1 → Phase 2 → Phase 3 必须严格串行（提示词模块内部有依赖链）
> - Phase 4、Phase 5 可在 Phase 1 完成后与 Phase 2/3 **并行**推进
> - Phase 6 须在 Phase 5 完成后开始（知识图谱左侧本体库面板依赖元本体数据）
> - Phase 7 须在 Phase 2~6 全部完成后执行

### 1.2 任务描述格式说明

每个子任务包含以下部分：

```
**功能描述**    → 详细说明该功能的交互逻辑和 UI 结构
**🎨 本次可见产出** → 完成后在浏览器中能看到/交互的变化
**验收方案**    → 逐项可勾选的验收清单：功能验收 / 交互验收 / 视觉验收
```

---

## 二、Phase 1：数据持久化基础层

**目标**：为后续所有模块建立统一的本地数据存储规范。本阶段无 UI 变化，但是所有后续功能能正常运行的前提。

### 1.1 localStorage 数据 Key 规范

在项目中统一以下 localStorage Key（各模块读写数据时必须使用这些 Key，避免 Key 名分散导致数据读不到）：

| 模块 | localStorage Key | 数据类型 |
|------|-----------------|---------|
| 模型管理 | `psy_models` | 模型配置对象数组 |
| 模型调度策略 | `psy_model_policy` | 调度策略配置对象 |
| 提示词模板列表 | `psy_prompt_templates` | 提示词模板对象数组 |
| 提示词分类树 | `psy_prompt_categories` | 分类节点树数组 |
| 元本体列表 | `psy_ontologies` | 本体对象数组 |
| 元本体分类树 | `psy_ontology_categories` | 分类节点树数组 |
| 元本体版本快照 | `psy_ontology_versions` | 版本快照数组 |
| 知识图谱数据 | `psy_knowledge_graph` | `{ nodes: [], edges: [] }` 对象 |
| 知识图谱节点坐标 | `psy_graph_layout` | `{ [nodeId]: { x, y } }` 对象 |

### 1.2 初始化加载策略

每个模块页面在初始化时，优先从对应的 localStorage Key 读取数据；若 Key 不存在或数据为空，则使用项目内置的 Mock 数据作为默认值并立即写入 localStorage。这样可保证首次使用有演示数据，后续操作的增删改会持久化保留。

**🎨 本次可见产出**：
- 各模块页面首次加载时，浏览器开发工具 Application → Storage → Local Storage 中可看到所有 `psy_*` Key 被创建并写入 Mock 数据
- 在任意模块进行增删改操作后刷新页面，数据依然存在（不回到初始 Mock 状态）

**验收方案**：
- [ ] 功能验收：9 个 `psy_*` Key 全部存在于 localStorage；首次加载自动写入 Mock 数据，二次加载读取已有数据，不再覆盖
- [ ] 数据验收：各 Key 的数据结构正确（数组/对象），无 undefined、null 值或格式错误
- [ ] 稳定性验收：刷新任意模块页面后数据完整，跨模块切换后数据不互相干扰

### Phase 1 阶段验收

| 验收项 | 标准 |
|--------|------|
| Key 完整性 | 9 个规定 Key 均已在各模块初始化时建立 |
| 读优先策略 | localStorage 有数据时不覆盖 Mock 数据 |
| 写入时机 | CRUD 操作后立即写入，不依赖页面刷新 |

---

## 三、Phase 2：提示词编辑器架构重构

> **这是整个修复计划最关键的一步。** 当前提示词编辑器使用单一自由文本框（Monaco Editor），用户可以随意删除任何内容（包括角色定义、约束条件等关键模块），导致 AI 输出不可控。必须先完成本阶段，再进行 Phase 3 的其他提示词功能建设。

**涉及页面**：`pages/Prompt.tsx` 中间编辑器区域

**改动类型**：整体替换中间编辑器（删除现有 Monaco Editor 自由文本模式，替换为结构化表单）

---

### 2.1 整体界面结构

中间编辑器区域由以下三层构成：

**顶部**：提示词类型选择器（下拉框）
- 选项：知识提取型 / 本体建模型 / 查询分析型 / 通用自定义
- 选择类型后，各 Tab 中的字段标签和占位文本随之变化，但字段结构不变

**中间**：6 个 Tab 页签切换
- Tab1 角色定义、Tab2 分析逻辑、Tab3 工作流程、Tab4 质量控制、Tab5 变量定义、Tab6 原始预览

**底部**：保存按钮（Ctrl+S 快捷键），保存状态指示（"已保存"绿点 / "未保存*"黄点）

**🎨 本次可见产出**：
- 提示词页面中间区域不再是一个大文本框，而是顶部类型下拉 + 6 个 Tab 页签 + 底部保存行的三段式结构
- 切换 Tab 时各 Tab 内容独立展示，无需滚动大文本

**验收方案**：
- [ ] 功能验收：原 Monaco 自由文本框已移除；顶部下拉可选 4 种类型；6 个 Tab 可正常切换，切换后各 Tab 内容独立且互不干扰
- [ ] 交互验收：在 Tab1 输入内容后切换到 Tab2，再切回 Tab1 内容仍在；Ctrl+S 键盘快捷键触发保存
- [ ] 视觉验收：三段式结构布局清晰，Tab 激活状态有明显高亮，底部保存状态指示图标正确（绿点/黄点）

---

### 2.2 Tab1 - 角色定义

**功能**：定义 AI 扮演的角色身份。本 Tab 所有字段**不可删除**（是每个提示词的必需模块），但字段内容可自由编辑。

**字段列表**：

| 字段 | 控件 | 是否必填 | 说明 |
|------|------|---------|------|
| 角色身份 | 单行输入框 | 必填 | 如"你是一位专业的司法心理学分析专家" |
| 专业领域 | 标签列表（可增删） | 选填 | 点击"+"添加标签，点击标签上的"×"删除，如"司法审讯 / 临床心理学" |
| 核心能力 | 标签列表（可增删） | 选填 | 同上，如"行为解析 / 动机推断 / 风险评估" |
| 示例说明 | 多行文本框 | 选填 | 支持 `{{变量名}}` 格式的占位符写法 |

**🎨 本次可见产出**：
- Tab1 显示 4 个字段区域：单行输入框（角色身份）、标签列表区域（专业领域）、标签列表区域（核心能力）、多行文本框（示例说明）
- 标签列表区域显示现有标签的彩色标签组件，末尾有"+"按钮

**验收方案**：
- [ ] 功能验收：角色身份输入框必填校验（保存时为空则报错提示）；专业领域和核心能力标签可通过"+"添加、通过"×"删除；`{{变量名}}` 文本可在示例说明中输入
- [ ] 交互验收：添加标签后标签立即出现在列表中；删除标签后列表立即更新；字段内容在切换 Tab 后保留
- [ ] 视觉验收：标签以胶囊样式展示（彩色背景，白色文字，右侧"×"）；必填字段标签旁有红色星号"*"标记

---

### 2.3 Tab2 - 分析逻辑

**功能**：定义 AI 的分析方法论和约束条件。字段**不可删除**，内容可编辑。

**字段列表**：

| 字段 | 控件 | 是否必填 | 说明 |
|------|------|---------|------|
| 核心原则 | 单行输入框 | 必填 | 如"基于证据链推理，避免主观臆断" |
| 分析方法 | 多行文本框 | 必填 | 描述分析方法论 |
| 约束条件 | 条目列表（可增删行） | 选填 | 每行一条约束，点击"+"添加新行，点击行右侧"×"删除该行 |
| 示例说明 | 多行文本框 | 选填 | 可含 `{{变量}}` |

**🎨 本次可见产出**：
- Tab2 显示 4 个字段区域：核心原则输入框、分析方法多行文本框、约束条件动态列表（每行为输入框+删除按钮）、示例说明多行文本框
- 约束条件区域底部有"+ 添加约束条件"按钮

**验收方案**：
- [ ] 功能验收：核心原则和分析方法均有必填校验；约束条件列表可增减行；约束条件已有 2~3 条 Mock 示例行
- [ ] 交互验收：点击"+ 添加约束条件"立即在列表末尾新增一个空行并聚焦；点击行右侧"×"立即移除该行，其他行不受影响
- [ ] 视觉验收：约束条件每行左侧显示序号或点符号；列表行与行之间有适当间距；约束条件区域整体在虚线边框内

---

### 2.4 Tab3 - 工作流程

**功能**：定义 AI 执行分析的分步骤流程。步骤数量**完全动态**，可任意增删、拖拽排序。

**UI 结构**：
- 每个步骤以折叠卡片（Collapse Panel）形式展示，卡片标题显示步骤编号和 stepId
- 卡片展开后包含三个字段：
  - **步骤标识（stepId）**：单行输入框，如"STEP_1"
  - **执行逻辑**：多行文本框，描述该步骤 AI 需要做什么，支持 `{{变量}}` 占位符
  - **步骤示例**：多行文本框，提供该步骤的输入/输出示例
- 卡片右上角有"删除本步骤"按钮（带二次确认）
- 步骤列表底部有"+ 添加步骤"按钮，点击后在末尾新增一张空白卡片
- 步骤之间支持拖拽排序（拖拽卡片左侧的拖动手柄图标）

**🎨 本次可见产出**：
- Tab3 显示 2~3 张折叠卡片（Mock 示例步骤），每张卡片展开后有 stepId + 执行逻辑 + 步骤示例三个字段
- 列表底部有"+ 添加步骤"按钮
- 每张卡片左侧有可拖拽的手柄图标（竖排点状图标）

**验收方案**：
- [ ] 功能验收：点击"+ 添加步骤"在末尾新增空白卡片；点击卡片"删除"按钮弹出确认对话框，确认后该步骤移除；各步骤字段内容独立，互不干扰
- [ ] 交互验收：折叠卡片标题可点击展开/收起；拖拽手柄可将卡片上下移动调整顺序（拖拽结束后顺序持久）；新增步骤后卡片自动展开等待输入
- [ ] 视觉验收：卡片展开/收起有展开箭头图标切换；步骤编号随顺序自动更新（如移动步骤后编号重排）；删除按钮为红色或危险色

---

### 2.5 Tab4 - 质量控制

**功能**：定义 AI 输出结果的质量要求。字段**不可删除**，内容动态可增删。

**字段列表**：

| 字段 | 控件 | 说明 |
|------|------|------|
| 输出检查点 | 条目列表（可增删行） | 每条是 AI 输出时需要满足的要求，如"必须包含置信度评分" |
| 避免事项 | 条目列表（可增删行） | 每条是 AI 输出时需要避免的行为，如"不得直接给出结论而不提供依据" |

**🎨 本次可见产出**：
- Tab4 分为两个区域：输出检查点列表 和 避免事项列表，各有独立的"+ 添加"按钮
- 两个列表均预置 2~3 条 Mock 示例内容

**验收方案**：
- [ ] 功能验收：两个列表均可独立增删条目；两个列表互不影响；增删操作数据写入临时状态（保存后才写 localStorage）
- [ ] 交互验收：点击"+ 添加"在末尾新增一个空行并自动聚焦；点击行右侧"×"立即删除该行；行内容实时编辑无需额外确认
- [ ] 视觉验收：两个列表有清晰的标题分隔（如"✓ 输出检查点"和"✗ 避免事项"）；添加按钮为文字链接风格（避免与主按钮混淆）

---

### 2.6 Tab5 - 变量定义

**功能**：自动扫描 Tab1~Tab4 所有文本中的 `{{变量名}}` 占位符，汇总展示，并允许填写每个变量的说明和默认值。

**UI 结构**：
- 顶部提示："以下变量从提示词内容中自动提取，修改提示词内容后点击刷新更新列表"
- 变量列表表格，列：变量名 | 出现位置 | 说明（可编辑输入框）| 默认值（可编辑输入框）
- 此 Tab 内容为只读计算结果，变量名不可在此手动增删（须在对应 Tab 的文本中通过 `{{变量}}` 语法增删）
- 顶部"刷新变量"按钮，点击后重新扫描所有 Tab 内容，更新变量列表

**🎨 本次可见产出**：
- Tab5 显示一张从其他 Tab 内容中提取的变量表格（如提取了 `{{entity_name}}`、`{{entity_description}}` 等）
- 变量名列只读，说明和默认值列可点击编辑

**验收方案**：
- [ ] 功能验收：Tab5 中显示的变量名与 Tab1~Tab4 文本中所有 `{{xxx}}` 完全对应（不多不少）；说明和默认值可编辑并保存；点击"刷新变量"后列表更新（新增或删除的变量正确反映）
- [ ] 交互验收：变量名列无法点击编辑；说明/默认值列点击后出现输入框；在其他 Tab 新增 `{{新变量}}` 后点击刷新，该变量出现在列表中
- [ ] 视觉验收：变量名以等宽字体（`monospace`）或代码样式展示；出现位置列显示来源 Tab 标签（如"Tab1 角色定义"）

---

### 2.7 Tab6 - 原始预览

**功能**：将 Tab1~Tab4 的结构化数据编译为一段完整的 prompt 文本，供用户预览最终发送给 AI 的实际内容。

**UI 结构**：
- 只读 Monaco Editor（不可编辑），使用等宽字体渲染编译后的完整 prompt 文本
- 顶部提示："此视图为只读预览，如需修改请前往对应 Tab"
- 右上角提供"复制全文"按钮

**🎨 本次可见产出**：
- Tab6 显示一个只读的代码编辑器风格区域，内容是将 Tab1~Tab4 所有字段按预设格式拼接的完整 prompt 文本
- 点击"复制全文"按钮后提示复制成功

**验收方案**：
- [ ] 功能验收：Tab6 内容是 Tab1~Tab4 所有字段的拼接结果，修改其他 Tab 内容后切到 Tab6 内容自动更新；"复制全文"按钮正常工作
- [ ] 交互验收：Monaco Editor 区域无法输入或修改（只读模式）；点击编辑器内文字时只显示只读光标；内容较长时有滚动条
- [ ] 视觉验收：编辑器背景色有明显与可编辑状态的区分（如浅灰色背景）；顶部只读提示文字清晰可见；编译后的 prompt 文本有适当的换行和缩进，可读性好

---

### Phase 2 阶段验收

| 验收项 | 标准 |
|--------|------|
| 架构替换 | 原有 Monaco Editor 自由文本框已从 Prompt 页面完全移除 |
| Tab 完整性 | 6 个 Tab（角色定义/分析逻辑/工作流程/质量控制/变量定义/原始预览）全部可正常访问 |
| 数据联动 | Tab6 原始预览内容能正确反映 Tab1~4 的所有字段变更 |
| 结构约束 | 各 Tab 的固定字段区域（角色身份/核心原则/检查点区域）均不可被删除，只能编辑内容 |
| 保存机制 | Ctrl+S 快捷键或保存按钮正常工作，保存状态指示正确切换 |

---

## 四、Phase 3：提示词模块功能补全

> **前置条件**：Phase 2 架构重构已完成。本阶段所有功能都基于结构化的 `PromptTemplate` 数据对象运作。

**涉及页面**：`pages/Prompt.tsx`（左侧分类树、中间编辑器顶部操作栏、右侧测试面板）

---

### 3.1 【紧急】提示词列表与切换

**改动类型**：修改左侧区域 + 新增数据交互逻辑

**当前现状**：左侧分类树是静态 HTML，点击任何条目都不会切换中间编辑器的内容。整个模块只有一个固定的初始示例提示词，无法新建或切换。

**期望功能**：

**左侧树展示**：
- 按分类（父节点）+ 提示词条目（子节点）两级树形展示
- 每个分类节点显示该分类下的提示词数量角标（如"知识提取 (3)"）
- 点击提示词条目后：该条目高亮显示，中间编辑器加载该提示词的结构化数据到各 Tab

**新建提示词**：
- 分类节点右侧 hover 显示"+"图标，点击后弹出小对话框
- 对话框包含：提示词名称（必填输入框）+ 提示词类型（下拉选择：知识提取型/本体建模型/查询分析型/通用自定义）
- 确认后创建一个含空白字段的新提示词对象，写入 localStorage，左侧树立即新增该条目，自动选中并在编辑器中展开

**条目操作（hover 时显示操作图标）**：
- **重命名**：点击后条目名称变为可编辑输入框，回车或失焦后确认
- **复制**：克隆当前提示词，命名为"原名称 (副本)"，插入到同级
- **删除**：弹出确认对话框，确认后从列表移除，编辑器自动跳转到同分类下第一条提示词；若该分类已无提示词则显示空态提示

**数据持久化**：所有增删改操作实时写入 `psy_prompt_templates` 和 `psy_prompt_categories`

**🎨 本次可见产出**：
- 左侧树显示从 `psy_prompt_templates` 加载的提示词列表（非静态 HTML），点击不同条目，中间编辑器内容切换
- hover 某条目出现操作图标（重命名/复制/删除）
- 分类节点 hover 出现"+"图标，点击后弹出新建对话框

**验收方案**：
- [ ] 功能验收：点击左侧树中 3 个不同提示词，中间编辑器各 Tab 内容均正确切换；新建提示词流程完整（弹窗→填名→确认→树中出现→编辑器加载）；删除条目后树列表更新，localStorage 中对应条目消失
- [ ] 交互验收：重命名操作：双击条目名称变为输入框，回车确认后树中显示新名称；切换提示词时若有未保存改动，弹出保存确认对话框
- [ ] 视觉验收：当前选中条目有明显高亮背景；分类节点显示正确的数量角标；hover 时操作图标以小图标形式出现，不占用条目主体空间

---

### 3.2 【紧急】提示词保存持久化

**改动类型**：修改保存逻辑（当前仅 console.log）

**当前现状**：点击保存按钮只在控制台打印内容，不写入任何存储，刷新后内容丢失。

**期望功能**：
- 点击"保存"按钮（或按 Ctrl+S），将当前编辑器中所有 Tab 的结构化数据整合为一个 `PromptTemplate` 对象，写入 `psy_prompt_templates` 数组（按 id 更新对应条目）
- 编辑器标题栏右侧显示保存状态：
  - 已保存：绿色圆点 + "已保存"文字
  - 有未保存改动：黄色圆点 + "未保存*"文字（任意 Tab 的任意字段被修改后立即切换为此状态）
- 切换到其他提示词前，若有未保存改动，弹出提示："当前有未保存的修改，是否保存？"（保存 / 不保存 / 取消）

**🎨 本次可见产出**：
- 编辑器顶部区域右侧显示保存状态指示（绿点"已保存" / 黄点"未保存*"）
- 修改任意字段后状态立即变为黄点"未保存*"；按 Ctrl+S 后立即变为绿点"已保存"
- 刷新页面后，已保存的内容在重新点击该条目时完整恢复

**验收方案**：
- [ ] 功能验收：保存后刷新页面，重新点击同一条提示词，各 Tab 字段内容与保存前完全一致；浏览器 localStorage 中 `psy_prompt_templates` 的对应条目已更新
- [ ] 交互验收：修改 Tab1 任意字段后，状态立即变为"未保存*"（无延迟）；按 Ctrl+S 触发保存，状态变为"已保存"；切换其他条目时若状态为"未保存*"，弹出确认对话框
- [ ] 视觉验收：状态指示绿点（已保存）和黄点（未保存）颜色区分明确；状态文字简洁清晰；保存状态区域位置固定（不随内容滚动）

---

### 3.3 【高】左侧分类树 CRUD

**改动类型**：新增分类树的增删改交互

**当前现状**：分类树只能展开/收起，"+"按钮无任何点击响应，无法新建或管理分类。

**期望功能**：

**新建分类**：
- 分类树顶部"+"按钮点击后，在树末尾出现一个内联输入框（高亮边框）
- 用户输入分类名后按回车或点击确认图标，新分类节点出现在树底部；按 Esc 取消

**分类节点操作（hover 时显示操作图标）**：
- **新建子分类**：在该分类节点下新增子分类（只做两级：大类和小类）
- **重命名**：节点名称变为可编辑状态
- **删除**：确认后删除分类，该分类下所有提示词移入"未分类"

**底部快捷入口**（固定显示在分类树底部）：
- ⭐ 我的收藏：点击后显示所有被标记收藏的提示词（提示词条目上提供收藏图标）
- 🕐 最近使用：显示最近打开过的 5 条提示词

**搜索联动**：分类树顶部搜索框联动过滤——同时匹配分类名和提示词名，不匹配的条目隐藏，匹配的关键词高亮显示

**🎨 本次可见产出**：
- 分类树顶部"+"按钮点击后出现内联输入框（而非弹窗），输入分类名回车后树中出现新分类节点
- hover 分类节点时出现新建子分类/重命名/删除三个图标
- 分类树底部固定显示"我的收藏"和"最近使用"两个入口
- 搜索框输入时左侧树条目实时过滤，匹配关键词高亮

**验收方案**：
- [ ] 功能验收：新建分类→输入名称→回车后树中出现新节点，`psy_prompt_categories` 更新；重命名后分类名称变更并持久化；删除分类后该分类下提示词出现在"未分类"中
- [ ] 交互验收：按 Esc 取消内联输入；hover 时操作图标出现流畅（无闪烁）；"我的收藏"点击后左侧树切换展示收藏列表，再次点击恢复完整树
- [ ] 视觉验收：内联输入框边框高亮明显；底部"我的收藏"和"最近使用"与普通分类有视觉区分（如图标不同、字体颜色不同）；搜索高亮关键词以黄色或橙色背景标记

---

### 3.4 【高】版本历史 Tab

**改动类型**：在结构化编辑器中新增 Tab（Tab4 质量控制之后、Tab5 变量定义之前插入）

**期望功能**：

**版本列表**：列表行：版本号 | 创建时间（精确到秒）| 变更说明 | 操作按钮（查看/对比/回滚）

**创建版本快照**：编辑器顶部操作栏增加"创建快照"按钮，点击弹出填写备注的输入框，确认后将当前结构化数据整体存入版本列表

**查看版本**：点击"查看"以只读方式展示该版本各 Tab 内容，顶部显示版本信息提示条，提供"返回编辑"和"回滚到此版本"按钮

**对比版本**：勾选两个版本后"对比"按钮激活，点击后双列展示差异（新增绿色/删除红色/修改黄色）

**回滚**：点击"回滚"弹出确认框，确认后当前编辑器内容被历史版本覆盖，同时自动创建一条新快照（备注"系统：回滚自 vX"）

**🎨 本次可见产出**：
- 编辑器新增一个版本历史 Tab，其中显示版本快照列表（含 2 条 Mock 历史版本）
- 编辑器顶部操作栏出现"创建快照"按钮
- 版本列表中每行显示版本号、时间、备注和操作按钮

**验收方案**：
- [ ] 功能验收：点击"创建快照"→填备注→确认后，版本列表新增一行；查看历史版本时各 Tab 均为只读状态（无法输入）；回滚后当前编辑器各 Tab 内容替换为历史版本的对应内容，且历史版本列表自动新增一条"系统：回滚"记录
- [ ] 交互验收：对比视图勾选两个版本后"对比"按钮才可点击；回滚确认弹窗有取消按钮可安全退出；查看历史版本时顶部提示条颜色有区分（蓝色/橙色信息条）
- [ ] 视觉验收：版本列表行有斑马纹或分隔线；当前版本（最新）在列表顶部并有"当前"标签；对比视图两列有明显的颜色差异高亮（增/删/改三色）

---

### 3.5 【中】编辑器顶部操作按钮完善

**改动类型**：新增操作按钮

**当前现状**：编辑器顶部操作栏只有"复制内容"一个按钮。

**期望功能**：增加以下三个操作按钮（放置于"保存"按钮旁）：
- **另存为**：弹出输入框填写新名称，克隆当前提示词完整数据，生成新 id 副本写入 localStorage，左侧树增加该条目并自动选中
- **删除**：弹出确认对话框，确认后从 localStorage 中移除，左侧树自动跳转到同分类下第一条
- **导出**：下拉菜单两个选项："导出为 JSON"（下载 `提示词名称.json`）和"导出为文本"（下载 `提示词名称.md`）

**🎨 本次可见产出**：
- 编辑器顶部操作栏出现"另存为"、"删除"、"导出"三个按钮（或图标按钮）
- 点击"导出"出现下拉菜单（JSON/文本两个选项）

**验收方案**：
- [ ] 功能验收：另存为后左侧树出现新条目，编辑器切换到新条目；删除后左侧树该条目消失，编辑器跳转到下一条；导出 JSON/文本均成功触发浏览器文件下载
- [ ] 交互验收：删除操作必须经过二次确认弹窗；导出下拉菜单点击空白区域可关闭；另存为弹窗输入框为空时确认按钮禁用
- [ ] 视觉验收：操作按钮与"保存"主按钮视觉层级区分（如次按钮为边框样式）；删除按钮为红色或危险色调；导出按钮有下载图标

---

### 3.6 【中】测试面板结果后处理

**改动类型**：在测试面板测试结果区域下方新增操作按钮

**当前现状**：测试完成后只展示耗时和 Token 统计数字，没有任何后续操作入口。

**期望功能**：

**保存测试记录**：测试结果区域底部增加"保存记录"按钮，点击后将本次测试信息（时间/模型/输入变量/结果/耗时/Token）保存到 localStorage（Key：`psy_prompt_test_history`），按钮短暂变为"已保存"

**应用到本体**：仅在测试结果为合法 JSON 时激活，点击后弹出确认对话框（含 JSON 摘要预览），确认后将结果解析写入 `psy_ontologies`，弹出 Toast 提示

**🎨 本次可见产出**：
- 测试面板底部（耗时统计下方）出现"保存记录"和"应用到本体"两个按钮
- 测试结果为纯文本时"应用到本体"按钮灰色禁用；测试结果为合法 JSON 时激活变为可点击状态
- 点击"保存记录"后按钮短暂变为绿色"已保存"

**验收方案**：
- [ ] 功能验收：点击"保存记录"后，浏览器 localStorage 中 `psy_prompt_test_history` 出现对应记录（含测试时间戳）；"应用到本体"在 JSON 结果时可点击，点击确认后 `psy_ontologies` 新增对应条目
- [ ] 交互验收：非 JSON 结果时"应用到本体"按钮有 disabled 样式且 hover 时显示 tooltip（"测试结果需为 JSON 格式才可应用"）；确认对话框可取消
- [ ] 视觉验收："保存记录"按钮短暂变为"已保存"（绿色，持续约 2 秒后恢复）；两个按钮左右排列或上下排列，与测试结果内容区有明显分隔

---

### Phase 3 阶段验收

| 验收项 | 标准 |
|--------|------|
| 列表切换 | 左侧树点击任意提示词条目，中间编辑器内容正确加载对应数据 |
| 持久化 | 保存操作后刷新页面，数据完整恢复；新增/删除提示词后刷新也生效 |
| 分类管理 | 新增/重命名/删除分类均正常，删除分类时提示词安全移入"未分类" |
| 版本功能 | 创建快照→查看历史→对比差异→回滚四个流程均可完整走通 |
| 后处理 | 保存测试记录和应用到本体功能在对应条件下均可正常触发 |

---

## 五、Phase 4：模型管理模块补全

> **前置条件**：Phase 1 完成。本 Phase 与 Phase 2/3 可并行进行，互不依赖。

**涉及页面**：`pages/Model.tsx`（调度策略 Tab、性能监控 Tab、模型卡片）

---

### 4.1 【高】调度策略 Tab

**改动类型**：替换当前占位符，实现完整的调度策略配置界面

**当前现状**：调度策略 Tab 显示一个居中的灰色图标和"调度策略配置区域"文字，是纯占位符。

**期望功能**：

**默认策略选择（页面顶部）**：
- 4 选 1 的 Radio 按钮组，选项：质量优先 / 平衡选择 / 速度优先 / 成本优先
- 每个选项下方有一行说明文字（如"质量优先：始终选择能力最强的模型，不考虑成本和速度"）
- 底部"保存策略"按钮将当前配置写入 localStorage（Key：`psy_model_policy`）

**任务-模型映射表格（页面中部）**：
- 列定义：任务类型 | 首选模型（下拉） | 备用模型1（下拉） | 备用模型2（下拉） | 优先级（数字）
- 模型下拉选项从 `psy_models` 中读取已启用（`enabled: true`）的模型
- 预置 6 行任务类型（不可删除）：文本分析 / 图片分析 / 报告生成 / 本体提取 / 情感识别 / 摘要总结
- 底部"新增任务类型"按钮：内联添加一行，任务类型名称可自定义

**负载均衡配置（页面底部，折叠面板，默认收起）**：
- 最大并发数（1~50，默认5）、单次请求超时（5~120秒，默认30）、失败重试次数（0~5，默认2）、重试间隔（1~30秒，默认3）

**🎨 本次可见产出**：
- 调度策略 Tab 中出现 Radio 按钮组（4种策略可选）、任务-模型映射表格（6行预置数据）、可折叠的负载均衡配置面板
- 灰色占位符图标和文字已消失

**验收方案**：
- [ ] 功能验收：点击不同 Radio 选项可切换选中状态；映射表格每行的模型下拉可选择已启用的模型；"保存策略"后 `psy_model_policy` 写入 localStorage；刷新页面后上次保存的策略仍选中
- [ ] 交互验收：点击"新增任务类型"在表格末尾插入可编辑的新行；负载均衡折叠面板点击标题可展开/收起；所有数字输入框支持直接输入和上下箭头调整
- [ ] 视觉验收：当前选中 Radio 项有高亮边框；表格行在 hover 时有浅色背景；负载均衡配置面板折叠状态下显示当前配置摘要（如"并发5 超时30s"）

---

### 4.2 【高】性能监控 Tab

**改动类型**：替换当前占位符，实现数据可视化监控界面

**当前现状**：性能监控 Tab 显示一个居中的灰色图标和文字，是纯占位符。

**期望功能**：

**顶部概览卡片区（4 个横排卡片）**：
- 今日总请求数 / 综合成功率 / 平均响应时间 / 今日费用估算
- 卡片右上角有时间范围切换：今日 / 近 7 天 / 近 30 天（切换后下方图表数据更新）

**响应时间趋势图（折线图）**：
- X 轴：时间；Y 轴：响应时间（毫秒）；每个已启用模型一条折线（颜色不同）

**Token 消耗柱状图**：X 轴为各模型名称，每组两根柱子（输入 Token 蓝色、输出 Token 橙色）

**错误率环形图**：展示各错误类型占比（超时/Key失效/内容过滤/其他），图表中央显示总错误数

**模型明细统计表格（页面底部）**：
- 列：模型名称 | 今日请求数 | 成功率 | 平均响应时间 | 总 Token | 估算费用 | 状态

> 所有监控数据使用静态 Mock 数据，图表使用 Recharts 库（项目内已有或可添加）。

**🎨 本次可见产出**：
- 性能监控 Tab 中出现 4 个概览数字卡片、1 个折线图、1 个柱状图、1 个环形图、1 个明细表格
- 灰色占位符已消失；切换时间范围（今日/近7天）图表数据发生变化

**验收方案**：
- [ ] 功能验收：4 个概览卡片均显示数字（非占位符）；3 个图表均正常渲染（无报错、无空白）；明细表格有至少 3 行模型数据；切换时间范围后折线图和柱状图数据更新
- [ ] 交互验收：时间范围切换按钮（今日/近7天/近30天）点击后对应按钮高亮，图表数据变化；hover 图表数据点时显示 Tooltip（具体数值）
- [ ] 视觉验收：4 个概览卡片横排等宽，每张卡片有图标、标题、数字三层；折线图各模型颜色不同且有图例；图表与图表之间有适当间距，整体页面无滚动或适量滚动

---

### 4.3 【中】模型连接测试功能

**改动类型**：为现有"测试连接"按钮添加交互逻辑

**当前现状**：测试连接按钮（刷新图标）在 hover 时显示，但点击无任何反应，没有 onClick 处理器。

**期望功能**：
- 点击后按钮图标改为旋转 Loading 动画，持续 500~1500ms（随机，模拟真实网络延迟）
- 测试结果逻辑：
  - 该模型 API Key 字段为空 → 失败：红色 Toast "连接失败：API Key 未配置"
  - API Key 不为空 → 成功：绿色 Toast "连接成功！延迟：XXXms"（延迟数字与 Loading 时长匹配）
- 测试成功后卡片上的延迟标签刷新为本次结果；Loading 期间按钮禁用

**🎨 本次可见产出**：
- 点击任意模型卡片的测试连接按钮后，按钮图标开始旋转（Loading 动画），500~1500ms 后停止并在右下角弹出 Toast 提示

**验收方案**：
- [ ] 功能验收：API Key 为空的模型点击测试后 Toast 显示"连接失败"；API Key 不为空的模型显示"连接成功 + 延迟数值"；成功后卡片延迟标签更新为本次测试结果
- [ ] 交互验收：Loading 期间按钮不可重复点击（显示禁用样式）；Toast 在 3 秒后自动消失；同时对多个模型点击测试时各自独立运行
- [ ] 视觉验收：Loading 时按钮图标旋转动画流畅；成功 Toast 为绿色，失败 Toast 为红色；Toast 从右下角滑入，消失时淡出

---

### 4.4 【中】模型卡片启用/禁用开关

**改动类型**：在模型卡片上新增 Toggle Switch 控件

**当前现状**：模型卡片只有测试连接/配置/删除三个操作，没有启用/禁用状态切换。

**期望功能**：
- 每张模型卡片右上角新增 Toggle Switch（开关组件）
- **开启状态**：卡片正常显示，状态标签显示绿色"运行中"
- **关闭状态**：卡片整体呈灰色半透明（opacity 0.6），状态标签变为灰色"已禁用"，卡片上测试连接和删除操作不可用
- 禁用状态持久化到 `psy_models` 对应模型对象（`enabled: false`），刷新后保留
- 已禁用的模型在提示词测试面板的"选择模型"下拉中不显示
- 调度策略映射表格中，已禁用模型选项变灰并标注"(已禁用)"

**🎨 本次可见产出**：
- 每张模型卡片右上角出现 Toggle 开关，默认开启（绿色）；点击关闭后卡片变灰色半透明，状态标签变为"已禁用"
- 刷新页面后禁用状态保留

**验收方案**：
- [ ] 功能验收：关闭 Toggle 后 `psy_models` 中对应模型 `enabled` 字段变为 `false`；刷新页面后该卡片仍显示禁用状态；已禁用模型不出现在提示词测试面板的模型下拉中
- [ ] 交互验收：Toggle 切换有动画过渡（开关滑动）；禁用状态下卡片上的测试连接和删除按钮显示 disabled 样式，无法点击；再次点击 Toggle 重新启用，卡片恢复正常
- [ ] 视觉验收：开启状态 Toggle 为绿色，关闭状态为灰色；禁用卡片整体半透明且鼠标 cursor 无特别变化；状态标签"已禁用"为灰色，"运行中"为绿色

---

### 4.5 【低】模型查看详情

**改动类型**：新增"查看详情"操作入口和详情抽屉

**当前现状**：模型卡片的操作区只有测试连接/配置/删除三个按钮，无查看详情入口。

**期望功能**：
- 在模型卡片操作区新增"详情"按钮（信息图标 `i`）
- 点击后从页面右侧滑出抽屉（宽度 400px）
- 抽屉内容分三区：
  - **基本信息区**：完整配置（Base URL、API Key 脱敏为 `sk-***xxx`、Max Tokens、Temperature 等）
  - **历史连接测试记录**：列表，每行：时间 + 结果（成功/失败）+ 延迟，最多 10 条
  - **使用量统计（Mock）**：本月请求次数、消耗 Token 数、估算费用

**🎨 本次可见产出**：
- 模型卡片上出现"详情"图标按钮；点击后页面右侧滑出宽度 400px 的抽屉，内含三个信息区域

**验收方案**：
- [ ] 功能验收：每个模型卡片均有"详情"按钮；抽屉内三个区域（基本信息/历史测试/使用量）均有内容显示；API Key 以脱敏格式展示（非明文）
- [ ] 交互验收：点击抽屉外部区域或关闭按钮可关闭抽屉；抽屉打开时主界面可正常操作（非模态）；历史测试记录在点击"测试连接"成功/失败后自动追加新记录
- [ ] 视觉验收：抽屉从右侧滑入有动画（约 300ms）；三个区域有明确的标题分隔线；使用量统计数字用大字体突出展示

---

### Phase 4 阶段验收

| 验收项 | 标准 |
|--------|------|
| 调度策略 | Tab 内容完整可操作，策略选择和映射表格均可配置并持久化 |
| 性能监控 | 4 个概览卡片 + 3 个图表 + 明细表格全部正常渲染，时间范围切换生效 |
| 连接测试 | 点击测试有 Loading，结果 Toast 正确区分成功/失败，延迟标签刷新 |
| 启用/禁用 | Toggle 开关切换后卡片视觉变化，禁用模型不出现在提示词测试下拉 |
| 查看详情 | 详情抽屉正常滑出，含配置/历史测试/使用量三个区域 |

---

## 六、Phase 5：元本体管理模块补全

> **前置条件**：Phase 1 完成。本 Phase 与 Phase 2/3/4 可并行推进。

**涉及页面**：`pages/Ontology.tsx`（定义视图、关系图 Tab、左侧分类树）

---

### 5.1 【高】版本管理面板

**改动类型**：在定义视图左侧树下方新增可折叠的版本历史面板

**当前现状**：左侧分类树下方无任何版本相关 UI。

**期望功能**：

**版本历史折叠面板**（左侧分类树下方，默认收起）：
- 标题栏显示"版本历史 (vX)"，点击展开/收起
- 展开后显示版本列表：版本号 | 时间 | 备注摘要（最多20字）| 查看/回滚图标

**创建快照**（定义视图顶部操作栏新增"创建快照"按钮）：
- 点击弹出输入框，填写变更说明（选填）
- 确认后将当前 `psy_ontologies` 和 `psy_ontology_categories` 快照存入 `psy_ontology_versions`

**查看历史版本**：右侧内容区只读展示该版本的本体列表（所有操作按钮禁用），顶部显示"查看历史版本 vX"提示条，提供"返回当前版本"和"回滚到此版本"按钮

**回滚**：确认后用该版本数据覆盖当前 `psy_ontologies`，自动创建新快照（备注"系统：回滚自 vX"），本体列表立即刷新

**🎨 本次可见产出**：
- 定义视图左侧树下方出现"版本历史"折叠面板（默认收起，点击可展开）
- 定义视图顶部操作栏出现"创建快照"按钮
- 展开后显示 2 条 Mock 历史版本，每条有查看/回滚操作

**验收方案**：
- [ ] 功能验收：点击"创建快照"填备注确认后，版本列表新增一行，`psy_ontology_versions` 数据更新；查看历史版本时右侧本体列表所有增删改按钮均不可点击（只读）；回滚确认后本体列表立即展示历史数据，版本列表新增"系统：回滚"记录
- [ ] 交互验收：折叠面板展开/收起动画流畅；查看历史版本的顶部提示条颜色与正常状态有区分（如蓝色信息条）；回滚确认弹窗有取消按钮
- [ ] 视觉验收：版本列表每行有时间戳（精确到秒）；最新版本行在列表顶部并有"当前"标签；折叠面板标题栏的版本号随创建快照自动递增

---

### 5.2 【中】孤立本体检查

**改动类型**：在关系图 Tab 的工具栏新增"孤立检查"功能

**当前现状**：关系图工具栏只有选择/拖拽/缩放/适应画布按钮。

**期望功能**：
- 关系图 Tab 工具栏新增"孤立检查"按钮（警告图标），若上次检查有孤立节点则显示红色数量角标
- 点击后约 500ms Loading 动画，然后弹出结果面板（右侧抽屉或浮层）
- 结果面板：列出所有在关系图中没有任何边连接的本体节点；每行：本体名称 | 类型标签 | 创建时间 | 操作（定位/关联/忽略）
  - 定位：切换到定义视图并高亮选中该本体
  - 关联：切换到关系图 Tab 并高亮该节点，右侧弹出关系创建工具
  - 忽略：从本次结果列表中临时移除
- 若无孤立节点，显示绿色空态："所有本体均已建立关联关系 ✓"

**🎨 本次可见产出**：
- 关系图工具栏出现"孤立检查"按钮（带警告图标）
- 点击后出现短暂 Loading，然后右侧弹出结果面板，列出未关联的本体（使用 Mock 数据中人为设置 1~2 个无边节点）

**验收方案**：
- [ ] 功能验收：检查结果中列出的节点均确实在关系图中没有连线；点击"定位"后切换到定义视图且对应本体在列表中被高亮选中；点击"忽略"后该行从结果面板消失，其他行不受影响
- [ ] 交互验收：检查按钮点击后有 Loading 动画（500ms），动画期间按钮不可重复点击；结果面板有关闭按钮；若有孤立节点，检查按钮上的红色角标显示孤立数量
- [ ] 视觉验收：结果面板有标题"孤立本体检查结果（共X个）"；无孤立节点时显示绿色图标 + 文字，有视觉反馈；操作按钮（定位/关联/忽略）大小合适，不过于拥挤

---

### 5.3 【中】关系图工具栏完善（导出图片 + 全屏）

**改动类型**：在关系图 Tab 工具栏新增两个按钮

**当前现状**：关系图工具栏有选择/拖拽/放大/缩小/适应画布，缺少导出和全屏功能。

**期望功能**：
- **导出图片**：工具栏新增下载图标按钮，点击触发浏览器下载当前画布内容为 PNG 图片，文件名为"元本体关系图_日期.png"
- **全屏模式**：工具栏新增全屏图标按钮，点击后关系图画布铺满屏幕；全屏状态下按钮变为"退出全屏"图标，点击或按 Esc 退出

**🎨 本次可见产出**：
- 关系图工具栏末尾新增两个按钮：下载图标和全屏展开图标
- 点击下载图标后，浏览器弹出文件下载（PNG 图片）
- 点击全屏图标后，关系图画布铺满整个浏览器窗口

**验收方案**：
- [ ] 功能验收：点击导出图片，浏览器下载一个 PNG 文件，图片内容与当前画布一致（包含节点和边）；点击全屏后画布铺满屏幕，按 Esc 后退出全屏恢复原布局
- [ ] 交互验收：全屏模式下工具栏仍可访问（覆盖在画布上方）；退出全屏后页面布局无错位；导出过程中若画布为空，导出的图片为空白（不报错）
- [ ] 视觉验收：导出按钮为下载图标（向下箭头+横线）；全屏按钮为四角展开图标；退出全屏按钮为四角收缩图标；按钮 tooltip 文字正确（"导出图片"/"进入全屏"/"退出全屏"）

---

### 5.4 【低】关系图节点位置持久化

**改动类型**：新增节点拖拽后的坐标保存逻辑

**当前现状**：拖拽节点后切换 Tab 或刷新页面，节点回到力导向初始布局。

**期望功能**：
- 节点拖拽结束时，将所有节点当前坐标（x, y）保存到 `psy_graph_layout`
- 下次加载关系图时，若 `psy_graph_layout` 有数据则跳过自动布局，按保存坐标渲染
- 工具栏新增"重置布局"按钮，点击后清除 `psy_graph_layout`，重新触发力导向布局

**🎨 本次可见产出**：
- 在关系图中拖拽节点到指定位置，切换到定义视图 Tab 后再切回，节点仍在拖拽后的位置（不重新布局）
- 刷新页面后节点位置也保持
- 工具栏出现"重置布局"按钮

**验收方案**：
- [ ] 功能验收：拖拽 2~3 个节点后切换 Tab 再切回，节点位置与拖拽后一致；刷新页面后节点位置仍保持；`psy_graph_layout` localStorage Key 中有对应节点的坐标数据；点击"重置布局"后节点回到力导向初始布局，`psy_graph_layout` 被清空
- [ ] 交互验收：重置布局有确认对话框（避免误触）；重置后力导向布局动画正常触发；再次拖拽后坐标重新写入
- [ ] 视觉验收：拖拽操作流畅无卡顿；"重置布局"按钮有旋转箭头图标；按钮 tooltip 为"重置为自动布局"

---

### 5.5 【低】元本体分类树 CRUD

**改动类型**：在 `CategoryTree` 组件上增加节点的增删改操作

**当前现状**：分类树只能展开/收起和点击选中，没有增删改功能。

**期望功能**：
- 每个分类节点 hover 时，节点右侧显示图标组：+ 新建子分类 / ✏️ 重命名 / 🗑 删除
- **新建子分类**：点击后节点下方出现内联输入框，回车确认；按 Esc 取消
- **重命名**：当前节点名变为可编辑输入框，回车或失焦确认
- **删除**：确认弹窗中显示"此操作将把 X 个本体移入'未分类'，确认删除？"，确认后执行

**🎨 本次可见产出**：
- hover 分类节点时右侧出现三个小图标（新建/重命名/删除）
- 点击新建图标后，在该节点下方出现内联输入框（非弹窗）

**验收方案**：
- [ ] 功能验收：新建子分类→输入名→回车，树中出现子节点，`psy_ontology_categories` 更新；重命名→修改后，树中显示新名称并持久化；删除分类后该分类下本体的 `categoryId` 变更为"未分类"的 id
- [ ] 交互验收：hover 时图标出现/消失无闪烁；内联输入框出现时自动聚焦；按 Esc 取消操作，树恢复正常状态；删除弹窗中显示实际受影响本体数量
- [ ] 视觉验收：三个图标大小合适（约 14px）；hover 图标有色彩反馈（新建蓝色/删除红色）；删除图标悬停时变为红色

---

### 5.6 【低】导入本体功能

**改动类型**：为定义视图顶部"导入"按钮添加完整的文件导入逻辑

**当前现状**："导入"按钮存在但无 onClick，点击无响应。

**期望功能**：
- 点击"导入"后弹出文件选择对话框（只接受 `.json`）
- 文件读取后解析 JSON，校验每条记录需包含 `name`（字符串）、`type`（字符串）、`properties`（数组）三个字段
- 校验失败则弹出红色 Toast 提示具体错误（如"第 3 条记录缺少 type 字段"）
- 校验通过后弹出导入预览对话框：显示将导入 X 个本体（列出前 5 条名称+类型）；若有同名本体显示警告："已存在 Y 个同名本体，导入将跳过这些项"
- 确认后写入 `psy_ontologies`，本体列表刷新，弹出绿色 Toast："成功导入 X 个本体"

**🎨 本次可见产出**：
- 点击"导入"按钮后弹出系统文件选择框（只接受 `.json` 文件）
- 选择合法 JSON 文件后，页面弹出导入预览对话框（展示将要导入的内容摘要）
- 确认后本体列表新增导入的本体条目

**验收方案**：
- [ ] 功能验收：选择格式正确的 JSON 文件后，预览对话框显示正确的导入数量和前 5 条摘要；确认后本体列表新增对应条目，`psy_ontologies` 数据更新；同名本体被跳过，Toast 提示实际导入数量
- [ ] 交互验收：选择格式错误的文件（非 JSON 或字段缺失）时弹出错误 Toast，不打开预览对话框；预览对话框有取消按钮；文件选择后若用户取消（不选择文件）则无任何变化
- [ ] 视觉验收：预览对话框中有明确的"将导入 X 个本体"标题；同名冲突警告以黄色警告色块展示；确认按钮文字为"确认导入"（非简单"确定"）

---

### Phase 5 阶段验收

| 验收项 | 标准 |
|--------|------|
| 版本管理 | 创建快照→查看历史（只读）→回滚全流程可走通，数据正确写入 `psy_ontology_versions` |
| 孤立检查 | 检查按钮有 Loading，结果列表正确列出无边节点，定位/关联/忽略操作均有效 |
| 导出全屏 | 导出 PNG 文件可下载且内容正确，全屏/退出全屏正常，无布局错乱 |
| 布局持久化 | 拖拽节点后切换 Tab 再切回位置保持；刷新页面位置保持；重置布局有效 |
| 分类树 CRUD | hover 出现操作图标，新建/重命名/删除均正常，删除时本体安全移入"未分类" |
| 导入功能 | JSON 校验有效，预览摘要正确，确认后本体列表更新，同名去重逻辑生效 |

---

## 七、Phase 6：知识图谱模块补全

> **前置条件**：Phase 1 完成、Phase 5 完成（本体库面板和 AI 助手"基于本体生成"模式需要读取稳定的 `psy_ontologies` 数据）。

**涉及页面**：`pages/Knowledge.tsx`（整体布局调整 + 画布工具栏 + 右侧工具 Tab）

---

### 6.1 【紧急】AI 助手 Tab 实现

**改动类型**：替换右侧工具栏 AI 助手 Tab 的占位内容

**当前现状**：AI 助手 Tab 显示"功能开发中..."，完全未实现。

**期望功能**：

**模式切换**（Tab 内顶部 Radio Group）：基于本体生成 / 从文档提取

**模式一：基于本体生成**
1. 下拉选择本体类型（从 `psy_ontologies` 读取，默认"全部类型"）
2. 生成数量输入框（1~20，默认 5）
3. Checkbox 选项：包含关系边 / 随机属性值
4. "开始生成"按钮（宽度100%）
5. 点击后 Loading 约 1.5 秒，然后显示预览列表：每行一个节点 + Checkbox（默认全选）
6. "应用到画布"按钮：将勾选节点写入 graphData，G6 画布重新渲染

**模式二：从文档提取**
1. 文件上传区（拖拽或点击，支持 `.txt`、`.md`）
2. 提取目标 Checkbox：人物信息 / 情绪状态 / 行为表现 / 事件记录
3. "开始提取"按钮
4. 点击后显示进度条（0→100%，约 2 秒），进度条下方显示"正在分析文档..."
5. 完成后显示提取结果表格：实体名 | 类型标签 | 置信度（%）| 勾选框（默认全选）
6. "应用到画布"按钮：将勾选项转换为节点写入 graphData

**🎨 本次可见产出**：
- AI 助手 Tab 不再是占位符，顶部有模式 Radio 切换
- 模式一：可选本体类型、填数量、点击生成，1.5 秒后出现可勾选的节点预览列表
- 模式二：文件上传区可拖拽文件，点击提取后出现进度条动画，完成后出现结果表格

**验收方案**：
- [ ] 功能验收：模式一点击"开始生成"后出现预览列表，取消勾选部分节点后点击"应用到画布"，仅勾选的节点出现在 G6 画布中；模式二上传 .txt 文件后提取流程完整（进度条→结果表格→应用到画布），应用后画布出现对应节点
- [ ] 交互验收：模式切换（Radio）后下方内容区整体切换；预览列表全选/全不选有快捷按钮；进度条动画平滑（非跳变）；"应用到画布"后 Tab 状态重置（恢复到初始输入状态）
- [ ] 视觉验收：置信度列高于 80% 显示绿色，50%~80% 显示黄色，低于 50% 显示红色；预览节点列表每行有类型标签；进度条有百分比数字显示

---

### 6.2 【紧急】查询工具 Tab 实现

**改动类型**：替换右侧工具栏查询 Tab 的占位内容（当前与 AI 助手 Tab 共享"功能开发中..."）

**期望功能**：

**查询模式切换**（顶部 Radio）：自然语言查询 / Cypher 直接查询

**模式一：自然语言查询**
1. 多行输入框（约 60px 高），占位提示文字："用自然语言描述要查找的内容，如：查找张三的所有焦虑相关记录"
2. 历史查询折叠面板（默认收起），列出最近 5 条，点击可复用
3. 点击"查询"后约 1.5 秒 Loading，先展示转换后的 Cypher 代码块（等宽字体，右上角复制），然后展示结果列表
4. 结果列表：节点名称 + 类型标签 + "定位"链接；"定位"点击后 G6 画布聚焦并高亮该节点
5. 底部"导出结果"按钮（下拉：JSON / CSV）

**模式二：Cypher 直接查询**
1. 等宽字体 TextArea（约 120px 高，浅灰色背景），占位提示："MATCH (n) RETURN n LIMIT 25"
2. 操作按钮行：执行 / 格式化 / 保存（保存到常用模板）
3. 常用查询模板折叠面板：
   - 查找孤立节点（`MATCH (n) WHERE NOT (n)--() RETURN n`）
   - 查找所有关系（`MATCH (n)-[r]->(m) RETURN n, type(r), m`）
   - 点击模板自动填入编辑区
4. 查询结果区（与模式一相同的结果组件）

**🎨 本次可见产出**：
- 查询 Tab 不再是占位符，顶部有模式 Radio 切换
- 模式一：输入自然语言后点击查询，约 1.5 秒后依次出现 Cypher 代码块和结果列表
- 模式二：Cypher 编辑区中填入语句，点击执行后出现结果列表；点击常用模板自动填入

**验收方案**：
- [ ] 功能验收：自然语言查询输入后点击查询，Loading 后显示 Cypher 代码和结果列表（Mock 数据，结果条数 > 0）；结果列表中点击"定位"，G6 画布对应节点高亮并居中；导出结果下载的 JSON/CSV 文件内容与列表显示一致；Cypher 模式点击常用模板自动填入编辑区
- [ ] 交互验收：历史查询面板最多保留 5 条，超过后最旧的条目被移除；Cypher 编辑区"格式化"按钮点击后语句缩进对齐；结果列表为空时显示"未找到匹配节点"空态
- [ ] 视觉验收：Cypher 代码块有等宽字体和浅色代码背景；结果列表节点名称和类型标签布局清晰；"定位"链接为蓝色文字链接样式

---

### 6.3 【高】画布布局切换

**改动类型**：在左侧画布工具栏新增布局切换功能

**当前现状**：工具栏无布局切换功能，画布始终是力导向布局。

**期望功能**：
- 工具栏新增布局下拉选择器（显示当前布局名称 + 下拉箭头）
- 4 种布局选项：力导向（Force）/ 层次（Dagre）/ 辐射（Radial）/ 网格（Grid）
- 切换后 G6 画布平滑动画过渡到新布局（约 500ms）

**🎨 本次可见产出**：
- 画布工具栏出现布局选择下拉框（默认显示"力导向"）
- 选择"层次"后画布节点重新排列为自上而下的层次结构，有平滑过渡动画
- 选择"网格"后节点均匀排列为网格形式

**验收方案**：
- [ ] 功能验收：4 种布局均可正常切换；切换后所有节点和边正常渲染（无节点丢失、无边错位）；辐射布局以选中节点（无选中则取第一个节点）为圆心展开
- [ ] 交互验收：切换布局时有平滑动画（约 500ms），不是瞬间跳变；布局切换期间不可重复触发；布局切换后 G6 画布仍可正常拖拽节点和缩放
- [ ] 视觉验收：下拉选择器显示当前生效的布局名称；4 种布局有各自的布局图标（力导向圆形/层次树形/辐射星形/网格方形）

---

### 6.4 【高】图谱过滤器

**改动类型**：在画布工具栏新增过滤功能入口

**当前现状**：无节点过滤功能，画布始终显示所有节点。

**期望功能**：
- 工具栏新增"过滤"按钮（漏斗图标），点击后弹出 Popover 面板
- **按节点类型过滤**：Checkbox 多选列表，列出当前图谱中所有本体类型；取消勾选的类型对应节点和关联边变为半透明（opacity: 0.15）
- **按关键词过滤**：输入框实时过滤，不含关键词的节点半透明，匹配的节点高亮边框
- Popover 内有"重置"按钮，清空所有过滤条件
- 有过滤条件激活时，"过滤"按钮显示蓝色高亮 + 数量角标（如"2"）

**🎨 本次可见产出**：
- 工具栏出现漏斗图标按钮，点击后在按钮下方弹出过滤 Popover
- 取消勾选某类型（如"情绪"）后，画布中该类型节点立即变为半透明
- 有过滤条件时，漏斗按钮变蓝并显示角标

**验收方案**：
- [ ] 功能验收：取消勾选某类型后，该类型的所有节点及其连线均变半透明（opacity 约 0.15）；重新勾选后节点恢复正常；关键词输入后不含该词的节点立即变半透明，含该词节点有高亮边框；点击"重置"后所有节点恢复完全显示
- [ ] 交互验收：Popover 点击外部区域可关闭；过滤条件在 Popover 关闭后仍持续生效（不会重置）；"重置"按钮仅在有激活的过滤条件时高亮可用（否则灰色）
- [ ] 视觉验收：半透明节点的 opacity 约 0.15（明显但仍可辨认轮廓）；过滤按钮激活状态为品牌色；角标以红色小圆点+数字形式显示在漏斗图标右上角

---

### 6.5 【中】图谱数据持久化

**改动类型**：修改图谱数据初始化和更新逻辑

**当前现状**：图谱数据仅在 React state 中，页面刷新或路由切换后所有手动创建的节点和关系全部丢失。

**期望功能**：
- 初始化时优先从 `psy_knowledge_graph` 读取，没有则使用 Mock 数据并立即写入
- 每次 CRUD 操作后，自动将最新 `graphData` 写入 `psy_knowledge_graph`
- 工具栏保留"保存"按钮作为手动持久化入口，点击后弹出"图谱数据已保存"绿色 Toast

**🎨 本次可见产出**：
- 在知识图谱中新建一个节点，然后刷新页面，新建的节点依然存在（不回到 Mock 初始状态）
- 切换到其他页面再切回，图谱数据保持

**验收方案**：
- [ ] 功能验收：新建节点 → 刷新页面，节点仍存在；删除关系 → 刷新页面，关系仍已删除；`psy_knowledge_graph` localStorage Key 的 nodes/edges 数组与画布显示一致
- [ ] 交互验收：CRUD 操作后无需手动点击保存（自动持久化）；手动点击"保存"按钮弹出绿色 Toast 并在 3 秒后消失；多次连续操作不导致 localStorage 写入错误（无 quota 超限）
- [ ] 视觉验收：保存 Toast 从右下角或右上角弹出（与全局 Toast 位置一致）；Toast 颜色为绿色，文字为"图谱数据已保存"

---

### 6.6 【中】导入/导出图谱数据

**改动类型**：在画布工具栏新增导入和导出按钮

**当前现状**：工具栏无导入/导出功能。

**期望功能**：
- **导出 JSON**：工具栏新增下载图标按钮，点击将 `graphData`（nodes + edges 数组）序列化为 JSON，下载为"知识图谱_日期.json"
- **导入 JSON**：工具栏新增上传图标按钮，点击弹出文件选择（只接受 `.json`），校验格式需包含 `nodes` 数组和 `edges` 数组，校验通过后弹出确认框："将导入 X 个节点、Y 条关系，与现有数据合并（按 id 去重）"，确认后合并并重新渲染画布

**🎨 本次可见产出**：
- 工具栏出现两个按钮：下载图标（导出）和上传图标（导入）
- 点击导出后浏览器下载一个 JSON 文件，打开内容包含 nodes 和 edges 两个数组
- 导入该 JSON 文件后，确认框显示正确的节点数和关系数，确认后画布数据合并更新

**验收方案**：
- [ ] 功能验收：导出的 JSON 文件可正常用文本编辑器打开，内容结构为 `{ nodes: [...], edges: [...] }`；重新导入刚才导出的 JSON 后，确认框显示"X 个节点、Y 条关系"；合并去重逻辑有效（相同 id 的节点不重复添加）
- [ ] 交互验收：导入格式错误的 JSON（无 nodes/edges 字段）时弹出红色 Toast 提示错误，不打开确认框；确认框有取消按钮；合并后 G6 画布立即重新渲染
- [ ] 视觉验收：导出按钮为下载图标（箭头向下），导入按钮为上传图标（箭头向上）；两按钮有 tooltip 文字（"导出 JSON" / "导入 JSON"）

---

### 6.7 【中】左侧本体库面板

**改动类型**：在知识图谱页面布局左侧新增本体库面板

**当前现状**：知识图谱页面只有"画布区"和"右侧工具栏"两列，无左侧本体库。

**期望功能**：
- 画布左侧新增可折叠面板（展开约 200px 宽，收起后显示竖向"本体库"标签条）
- 展开内容：
  - 顶部搜索框（过滤本体名称）
  - 按本体类型分组的 Accordion 折叠列表，数据从 `psy_ontologies` 动态读取
  - 每个本体条目：彩色圆点（与画布节点颜色对应）+ 本体名称
  - 底部显示"共 X 个本体"
- **点击本体条目**：右侧工具栏自动切换到"节点"Tab，并将"本体类型"字段预填为对应值，用户只需填节点名称即可快速创建

**🎨 本次可见产出**：
- 知识图谱页面左侧出现一个可折叠的本体库面板
- 展开后显示分类折叠列表，各类型下列出对应本体名称
- 点击本体条目后，右侧节点工具 Tab 的"本体类型"下拉自动选中对应值

**验收方案**：
- [ ] 功能验收：面板内列出的本体与 `psy_ontologies` 数据一致（Phase 5 新增的本体也出现在面板中）；搜索框实时过滤；点击本体条目后右侧节点 Tab 的本体类型字段自动填充
- [ ] 交互验收：折叠/展开面板有动画（约 200ms）；收起后的"本体库"标签竖向文字可读；Accordion 各分类折叠展开独立，互不影响；搜索无结果时显示"未找到匹配本体"
- [ ] 视觉验收：彩色圆点颜色与画布中对应类型节点的颜色一致；面板收起后不占用画布主区域空间；展开面板时画布区域适当收窄（布局平衡）

---

### 6.8 【低】撤销/重做功能

**改动类型**：在画布工具栏新增撤销/重做按钮，建立操作历史机制

**当前现状**：无撤销/重做能力，操作错误只能手动删除。

**期望功能**：
- 工具栏新增撤销（Ctrl+Z，左弯箭头图标）和重做（Ctrl+Y，右弯箭头图标）按钮
- 每次 CRUD 操作后，将操作前的 `graphData` 快照推入历史栈（最多 20 步）
- 撤销：从栈顶弹出快照，恢复到该状态，G6 画布重新渲染
- 重做：从重做栈弹出并应用
- 无可撤销操作时撤销按钮灰色禁用；无可重做操作时重做按钮灰色禁用

**🎨 本次可见产出**：
- 工具栏出现撤销（←）和重做（→）两个按钮
- 新建一个节点后，点击撤销，该节点从画布消失
- 点击重做，节点重新出现

**验收方案**：
- [ ] 功能验收：创建节点 → 撤销 → 节点消失；再重做 → 节点复现；删除关系 → 撤销 → 关系恢复；历史栈最多 20 步，超过后最旧的步骤被丢弃；Ctrl+Z 和 Ctrl+Y 快捷键均有效
- [ ] 交互验收：初始状态（无操作历史）时两个按钮均灰色禁用；执行操作后撤销按钮激活；撤销到初始状态后撤销按钮再次禁用；撤销后重做执行新操作，重做栈清空（不可再 Ctrl+Y）
- [ ] 视觉验收：禁用按钮有明显灰色样式（opacity 降低）；按钮 tooltip 显示"撤销（Ctrl+Z）"和"重做（Ctrl+Y）"；快捷键说明显示在 tooltip 中

---

### Phase 6 阶段验收

| 验收项 | 标准 |
|--------|------|
| AI 助手 | 两种模式（基于本体生成/从文档提取）均有完整交互流程，应用到画布后节点正确出现 |
| 查询工具 | 自然语言和 Cypher 两种查询模式均正常，定位功能联动画布高亮 |
| 布局切换 | 4 种布局均可切换，有平滑动画，切换后节点/边正常渲染 |
| 图谱过滤 | 类型过滤和关键词过滤均生效，重置正常，激活状态按钮有角标 |
| 数据持久化 | CRUD 操作后刷新页面，数据完整保留 |
| 导入导出 | 导出 JSON 可下载，导入合并去重逻辑正确 |
| 本体库面板 | 可折叠展开，列表从 `psy_ontologies` 动态读取，点击自动填充节点类型 |
| 撤销重做 | Ctrl+Z/Y 有效，历史栈上限 20 步，按钮禁用状态正确 |

---

## 八、Phase 7：全局数据联动与 UI 规范

> **前置条件**：Phase 2~6 全部完成。本阶段负责打通各模块间的数据孤岛，并统一全局 UI 规范。

---

### 7.1 【高】模块间数据联动

**改动类型**：建立跨模块的数据共享机制

**当前现状**：元本体管理创建的本体，知识图谱使用的是硬编码 Mock 数据，无法感知新增本体；提示词测试的"选择模型"下拉需刷新才能感知模型变更。

**期望功能**：

**本体数据共享（元本体 → 知识图谱）**：
- 知识图谱模块初始化时从 `psy_ontologies` 读取本体列表
- 知识图谱的本体库面板（6.7）、AI 助手"基于本体生成"本体类型下拉（6.1）、右侧节点工具的本体类型下拉，均从 `psy_ontologies` 实时读取，不使用硬编码数据
- 元本体模块新增/删除本体后，知识图谱模块相关下拉在下次打开时即可看到最新列表

**模型数据共享（模型管理 → 提示词测试）**：
- 提示词测试面板的"选择模型"下拉从 `psy_models` 读取，只显示 `enabled: true` 的模型
- 模型管理中启用/禁用模型后，提示词测试面板在下次打开下拉时即可看到最新列表

**🎨 本次可见产出**：
- 在元本体管理中新增一个本体"测试本体A"，然后前往知识图谱页面，右侧节点工具的本体类型下拉中出现"测试本体A"
- 在模型管理中将某模型 Toggle 关闭，然后前往提示词管理→测试面板→打开模型下拉，该模型不在列表中

**验收方案**：
- [ ] 功能验收：元本体模块新增本体后，不刷新页面切换到知识图谱模块，节点工具的本体类型下拉包含新增本体；知识图谱 AI 助手的本体类型下拉也包含新增本体；模型禁用后，提示词测试模型下拉中不显示该模型
- [ ] 交互验收：数据共享通过统一 localStorage Key + 读取时机（每次打开下拉/进入页面时重新读取）实现，无需刷新页面；在元本体模块删除本体后，知识图谱本体库面板的该条目也消失
- [ ] 稳定性验收：各模块并发读写 localStorage 时无数据损坏；极端情况（如 localStorage 空间不足）时各模块有 fallback 到 Mock 数据的处理

---

### 7.2 【中】统一 Loading / Empty / Error 态组件

**改动类型**：新增三个共享 UI 组件，替换各模块各自的不一致实现

**当前现状**：各模块的加载态、空数据态处理方式不统一。

**期望功能**：新增三个共享组件（放置于 `components/` 目录）：

**LoadingSpinner**：居中旋转进度圈 + 可选说明文字（如"正在加载本体数据..."）

**EmptyState**：居中灰色插图（空盒子图标）+ 主说明文字 + 副说明文字 + 可选行动按钮（如"新建第一个提示词"）

**ErrorState**：居中错误图标 + 错误信息 + "重试"按钮

**全局 Toast 统一**：
- 当前各模块分别实现了 Toast，统一为一个挂载在根节点的全局 Toast 组件
- 支持四种类型：success（绿色）/ error（红色）/ warning（黄色）/ info（蓝色）
- 从右下角弹出，3 秒后自动消失；同时最多显示 3 条 Toast（超出时队列等待）

**🎨 本次可见产出**：
- 各模块的"加载中"状态统一为相同的旋转动画组件
- 各模块的空数据状态统一为相同的空态图标+文字样式
- 所有 Toast（来自各模块）均从页面同一位置（右下角）弹出，样式一致

**验收方案**：
- [ ] 功能验收：知识图谱、元本体、提示词、模型四个模块的 Loading 状态均使用同一 `LoadingSpinner` 组件；空数据场景（如无提示词时左侧树空列表）均使用 `EmptyState` 组件；操作成功/失败的 Toast 均从右下角弹出
- [ ] 交互验收：多个 Toast 同时出现时叠加排列（不重叠）；Toast 3 秒自动消失；同类型操作快速多次触发时 Toast 不堆积超过 3 条
- [ ] 视觉验收：四个模块的 Loading 动画样式完全一致（颜色、大小、速度）；EmptyState 的插图和文字在各模块中一致；Toast 的四种类型颜色清晰区分（绿/红/黄/蓝）

---

### Phase 7 阶段验收

| 验收项 | 标准 |
|--------|------|
| 本体数据共享 | 元本体新增/删除本体后，知识图谱节点工具、AI 助手、本体库面板的下拉均自动更新 |
| 模型数据共享 | 模型禁用后，提示词测试面板模型下拉中不显示该模型，无需刷新页面 |
| UI 组件统一 | Loading/Empty/Error 态在四个模块中视觉完全一致 |
| Toast 统一 | 所有模块的操作反馈 Toast 均从右下角弹出，样式一致，无多个位置冲突 |

---

## 九、完整验收矩阵

所有 Phase 完成后，按以下清单逐项验收：

### 数据基础层
- [ ] **P1** localStorage 的 9 个 `psy_*` Key 全部正确初始化，刷新页面数据不丢失

### 提示词模块
- [ ] **P2** 提示词编辑器中间区域为 6 Tab 结构化表单，原 Monaco 自由文本框已移除
- [ ] **P2** Tab1~Tab4 的固定字段区域不可被整体删除，只可编辑内容
- [ ] **P2** Tab6 原始预览内容正确反映 Tab1~4 所有字段，且为只读
- [ ] **3.1** 左侧树点击不同提示词条目，中间编辑器正确切换并加载对应数据
- [ ] **3.2** Ctrl+S 保存后刷新页面，数据完整恢复；保存状态指示（绿/黄点）正确切换
- [ ] **3.3** 分类树可新建/重命名/删除，删除分类时提示词安全移入"未分类"
- [ ] **3.4** 版本历史 Tab：创建快照→查看历史→对比差异→回滚四个流程均可完整走通
- [ ] **3.5** 另存为/删除/导出（JSON+文本）操作均功能正常
- [ ] **3.6** 保存测试记录写入 localStorage；应用到本体在合法 JSON 时可激活并导入

### 模型管理模块
- [ ] **4.1** 调度策略 Tab：Radio 组/映射表格/负载均衡配置均可操作，保存后持久化
- [ ] **4.2** 性能监控 Tab：4 卡片 + 折线图 + 柱状图 + 环形图 + 明细表格全部渲染正常
- [ ] **4.3** 连接测试：有 Loading 动画，按 API Key 是否填写区分成功/失败 Toast，延迟数值更新
- [ ] **4.4** 启用/禁用 Toggle：禁用后卡片灰色，禁用模型不出现在提示词测试模型下拉中
- [ ] **4.5** 查看详情抽屉：API Key 脱敏，历史测试记录/使用量统计三个区域均有数据

### 元本体管理模块
- [ ] **5.1** 版本管理：创建快照/查看历史（只读）/回滚流程完整，数据写入 `psy_ontology_versions`
- [ ] **5.2** 孤立检查：扫描结果正确，定位/关联/忽略操作有效，角标显示孤立数量
- [ ] **5.3** 导出图片：PNG 文件可下载，内容与画布一致；全屏/退出全屏正常
- [ ] **5.4** 布局持久化：拖拽节点后切换 Tab 再切回位置保持；重置布局按钮有效
- [ ] **5.5** 分类树 CRUD：hover 出现操作图标，新建/重命名/删除均正常
- [ ] **5.6** 导入功能：JSON 校验，预览摘要，确认后本体列表更新，同名去重

### 知识图谱模块
- [ ] **6.1** AI 助手：基于本体生成和从文档提取两种模式均有完整交互，应用到画布正确
- [ ] **6.2** 查询工具：自然语言和 Cypher 两种查询模式正常，定位功能联动画布高亮
- [ ] **6.3** 布局切换：4 种布局均可切换，有平滑动画，切换后节点/边正常渲染
- [ ] **6.4** 图谱过滤：类型过滤和关键词过滤均生效，重置正常，激活状态有角标
- [ ] **6.5** 数据持久化：CRUD 操作后刷新页面数据完整保留
- [ ] **6.6** 导入导出：导出 JSON 可下载，导入合并去重逻辑正确
- [ ] **6.7** 本体库面板：可折叠，列表动态读取，点击自动填充节点类型
- [ ] **6.8** 撤销重做：Ctrl+Z/Y 有效，历史栈上限 20 步，按钮禁用状态正确

### 全局数据联动
- [ ] **7.1** 元本体新增本体后，知识图谱相关下拉自动更新（无需刷新）
- [ ] **7.1** 模型禁用后，提示词测试模型下拉不显示该模型（无需刷新）
- [ ] **7.2** 四个模块 Loading/Empty/Error 态视觉完全一致
- [ ] **7.2** 所有模块 Toast 均从右下角弹出，样式一致，无多位置冲突

---

*计划版本：v1.0 | 创建日期：2026-02-19*
